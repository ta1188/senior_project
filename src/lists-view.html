<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="lists-view">
  <template>
    <style>
      :host {
        display: block;
      }
      .flex-row {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }
      .flex-row * {
        align-self: center;
      }
      .list-label {
        margin-left: 10px;
      }
      .blue {
        color: #2F80ED;
      }
      .plus-svg {
        fill: #2F80ED;
      }
      .grey {
        color: #BDBDBD;
      }
      .lists-svg {
        height: 30px;
        width: 30px;
        fill: #BDBDBD;
      }
      .add-btn {
        font-family: Verdana, Geneva, sans-serif;
        font-size: 14px;
        outline: none;
        border: none;
        padding: 10px 10px 10px 0;
        margin: 15px 0 0 0;
        background-color: transparent;
      }
      .add-btn:hover {
        cursor: pointer;
      }
      .item-container {
        margin-bottom: 10px;
      }
      #addListInput {
        font-family: Verdana, Geneva, sans-serif;
        padding: 10px 0;
        width: 78%;
        outline: none;
        border: none;
        background-color: transparent;
        color: #4F4F4F;
        font-size: 1rem;
        border-bottom: 1px solid #BDBDBD;
      }
      #addListInput:focus {
        border-bottom: 2px solid #BDBDBD;
      }
      [hidden] {
        display: none !important;
      }
      .shake-no {
        animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        transform: translate3d(0, 0, 0);
        backface-visibility: hidden;
        perspective: 1000px;
      }

      @keyframes shake {
        10%, 90% {
          transform: translate3d(-1px, 0, 0);
        }
        
        20%, 80% {
          transform: translate3d(2px, 0, 0);
        }

        30%, 50%, 70% {
          transform: translate3d(-4px, 0, 0);
        }

        40%, 60% {
          transform: translate3d(4px, 0, 0);
        }
      }
    </style>
    <firebase-query id="lists" 
                    path="/shopLists" 
                    order-by-child="userId" 
                    equal-to="{{uid}}" 
                    data="{{listData}}"></firebase-query>
    <firebase-document id="newList" path="/shopLists/" data="{{newListData}}"></firebase-document>
    <p>Hello [[prop1]]!</p>
    <template id="repeater" is="dom-repeat" items="[[items]]">
      <div id="[[item.$key]]" class="flex-row item-container" on-click="_viewList">
        <div class="flex-row">
          <svg class="lists-svg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
          </svg>
          <span class="list-label">[[item.listName]]</span>
        </div>
        <span class="grey">[[item.itemsLength]]</span>
      </div>
    </template>
    <button hidden="[[addingList]]" class="flex-row blue add-btn" on-click="showListInput">
      <svg class="plus-svg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        <path d="M0 0h24v24H0z" fill="none"/>
      </svg>
      <span>Add List</span>
    </button>
    <div class="flex-row" hidden="[[!addingList]]">
      <input id="addListInput" type="text" placeholder="List name...">
      <span id="addBtn" class="blue addBtn" on-click="addList">ADD</span>
    </div>
  </template>

  <script>
    class ListsView extends Polymer.Element {
      static get is() { return 'lists-view'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'lists-view'
          },
          listData: {
            type: Object,
            observer: "checkList"
          },
          listItems: {
            type: Array
          },
          user: {
            type: Object,
            observer: "checkUser"
          },
          listKey: {
            type: String,
            notify: true
          },
          addingList: {
            type: Boolean,
            value: false
          },
          uid: String,
          listName: String,
        };
      }
      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('listLength', this._updateLength.bind(this));
      }
      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('listLength', this._updateLength.bind(this));
      }
      checkUser(_user) {
        if (_user) {
          console.log('uid: ', window.app.user.uid);
          this.uid = _user.uid;
        }
      }
      checkList(_lists) {
        if (window.app.user.uid && _lists && _lists.length) {
          // NOTE: length of object is:
                //  `Object.keys(myObj).length`
          // this should be unnecessary... -----------------------------
          _lists.forEach(function(list) { 
            var itemsList = list.items;
            var tempArr = [];
            for (var key in itemsList) {
              if (itemsList.hasOwnProperty(key)) {
                tempArr.push(itemsList[key]);
              }
            }
            list.items = tempArr;
            list.itemsLength = tempArr.length;
          }); // -------------------------------------------------------
          console.log('list: ', _lists);
          this.items = _lists.slice();
          this.$.repeater.render();
        }
      }
      _viewList(e) {
        console.log('_viewList');
        var localTarget = Polymer.dom(e).localTarget;
        if (localTarget) {
          var listId = localTarget.closest('.item-container').id;
          var selectedList = this.items.filter(list => list.$key === listId);
          if (this.listName === selectedList[0].listName) {
            this.transitionPage();
          } else {
            this.listName = selectedList[0].listName;
            this.listKey = listId;
            this.transitionPage();
          }
        } 
      }
      transitionPage() {
        window.setBannerLabel(this.listName, true);
        window.history.pushState({}, null, 'list');
        window.dispatchEvent(new CustomEvent ('location-changed'));
      }
      _updateLength(event) {
        console.log('I hear you');
        if (event) {
          var _index;
          var list = this.items.filter(function(item, index) {
            if (item.$key === this.listKey) {
              _index = index;
              return item;
            }
          }.bind(this));
          var temp = this.listData;
          this.listData = [];
          temp[_index] = list[0];
          temp[_index].listLength = event.detail.length;
          // this.items = temp;
          this.set('items', temp);
          // this.$.repeater.render();
          // this._updateLists();
        }
      }
      showListInput() {
        this.addingList = true;
        this.$.addListInput.focus();
      }
      addList() {
        var listName = this.$.addListInput.value;
        if (!listName) {
          this.$.addBtn.classList.add('shake-no');
          setTimeout(function(){
            this.$.addBtn.classList.remove('shake-no');
          }.bind(this), 900);
        } else {
          this.newListData = {
            items: 0,
            listName: listName,
            userId: window.app.user.uid
          }
          this.$.newList.saveValue(this.$.newList.path).then(function(resp) {
            this.items = this.listData.slice();
            this._updateLists();
          }.bind(this));
          this.$.addBtn.classList.remove('shake-no');
          this.addingList = false;
        }
      }
      _updateLists(event) {
        if (event) {
          this.listData = this.listData.slice();
          // this.listData = event.detail.itemsArr;
          // this.
          console.log('updating', this.listData);
          // console.log('updating', event.detail.itemsArr);
          // this.notifyPath('listData');
          // this.$.repeater.render();
        }
      }
    }

    window.customElements.define(ListsView.is, ListsView);
  </script>
</dom-module>
