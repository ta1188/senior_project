<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="lists-view">
  <template>
    <style>
      :host {
        display: block;
      }
      .flex-row {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
      }
      .flex-row * {
        align-self: center;
      }
      .list-label {
        margin-left: 10px;
      }
      .blue {
        color: #2F80ED;
      }
      .plus-svg {
        fill: #2F80ED;
      }
      .grey {
        color: #BDBDBD;
      }
      .lists-svg {
        height: 30px;
        width: 30px;
        fill: #BDBDBD;
      }
      .add-btn {
        font-family: Verdana, Geneva, sans-serif;
        font-size: 14px;
        outline: none;
        border: none;
        padding: 10px 10px 10px 0;
        margin: 15px 0 0 0;
        background-color: transparent;
      }
      .add-btn:hover {
        cursor: pointer;
      }
    </style>
    <firebase-query id="lists" 
                    path="{{listPath}}" 
                    order-by-child="userId" 
                    equal-to="{{uid}}" 
                    data="{{listData}}"></firebase-query>

    <p>Hello [[prop1]]!</p>
    <template is="dom-repeat" items="[[items]]">
      <div id="[[item.$key]]" class="flex-row item-container" on-click="_viewList">
        <div class="flex-row">
          <svg class="lists-svg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
          </svg>
          <span class="list-label">[[item.listName]]</span>
        </div>
        <span class="grey">[[item.items.length]]</span>
      </div>
    </template>
    <button class="flex-row blue add-btn">
      <svg class="plus-svg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        <path d="M0 0h24v24H0z" fill="none"/>
      </svg>
      <span>Add List</span>
    </button>
  </template>

  <script>
    class ListsView extends Polymer.Element {
      static get is() { return 'lists-view'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'lists-view'
          },
          listData: {
            type: Object,
            observer: "checkList"
          },
          listItems: {
            type: Array
          },
          user: {
            type: Object,
            observer: "checkUser"
          },
          listKey: {
            type: String,
            notify: true
          },
          uid: String,
          listName: String,
        };
      }
      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('listLength', this._updateLength.bind(this));
      }
      disconnectedCallback() {
        super.disconnectedCallback();
        window.removeEventListener('listLength', this._updateLength.bind(this));
      }
      checkUser(_user) {
        if (_user) {
          console.log('uid: ', window.app.user.uid);
          this.uid = _user.uid;
          this.listPath = '/shopLists';
        }
      }
      checkList(_lists) {
        if (window.app.user.uid && _lists) {
          // this should be unnecessary... -----------------------------
          _lists.forEach(function(list) { 
            var itemsList = list.items;
            var tempArr = [];
            for (var key in itemsList) {
              if (itemsList.hasOwnProperty(key)) {
                tempArr.push(itemsList[key]);
              }
            }
            list.items = tempArr;
          }); // -------------------------------------------------------
          console.log('list: ', _lists);
          this.items = _lists;
        }
      }
      _viewList(e) {
        console.log('_viewList');
        var localTarget = Polymer.dom(e).localTarget;
        if (localTarget) {
          var listId = localTarget.closest('.item-container').id;
          var selectedList = this.items.filter(list => list.$key === listId);
          if (this.listName === selectedList[0].listName) {
            this.transitionPage();
          } else {
            this.listName = selectedList[0].listName;
            this.listKey = listId;
            this.transitionPage();
          }
        } 
      }
      transitionPage() {
        window.setBannerLabel(this.listName, true);
        window.history.pushState({}, null, 'list');
        window.dispatchEvent(new CustomEvent ('location-changed'));
      }
      _updateLength(event) {
        console.log('I hear you');
        if (event) {
          var _index;
          var list = this.items.filter(function(item, index) {
            if (item.$key === this.listKey) {
              _index = index;
              return item;
            }
          }.bind(this));
          var temp = this.items;
          temp[_index] = list[0];
          this.items = [];
          this.items = temp;
        }
      }
    }

    window.customElements.define(ListsView.is, ListsView);
  </script>
</dom-module>
